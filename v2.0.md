# v2.0 — 心跳续约与版本管理

## 代码结构

```
src/main/java/com/malinghan/maregistry/
├── MaregistryApplication.java          # Spring Boot 入口
├── MaRegistryController.java           # REST 控制器，新增 /renew /renews /version /versions 接口
├── model/
│   └── InstanceMeta.java               # 服务实例数据模型（无变化）
└── service/
    ├── RegistryService.java            # 注册服务接口，新增心跳和版本管理方法
    └── MaRegistryService.java          # 内存实现，新增时间戳和版本号管理
```

## 核心功能实现

### 新增数据结构

#### 时间戳管理 (TIMESTAMPS)
```java
private final Map<String, Long> TIMESTAMPS = new ConcurrentHashMap<>();
```
- Key格式：`service@scheme://host:port/context`
- Value：时间戳（毫秒）
- 用于记录每个服务实例的最后心跳时间

#### 服务版本号 (VERSIONS)
```java
private final Map<String, Long> VERSIONS = new ConcurrentHashMap<>();
```
- Key：服务名称
- Value：版本号（每次注册/注销/续约时递增）
- 用于客户端感知服务变化

#### 全局版本号 (VERSION)
```java
private final AtomicLong VERSION = new AtomicLong(0);
```
- 原子长整型，全局递增
- 跟踪整个注册中心的变更情况

### RegistryService 接口扩展

新增四个核心方法：

```java
InstanceMeta renew(String service, InstanceMeta instance);
InstanceMeta renews(String[] services, InstanceMeta instance);
Long version(String service);
Map<String, Long> versions(String[] services);
```

### MaRegistryService 实现细节

#### 心跳续约实现
- `renew()`: 更新单个服务实例的时间戳，递增服务版本号和全局版本号
- `renews()`: 批量更新多个服务实例，减少网络请求次数

#### 版本管理实现
- `version()`: 获取单个服务的当前版本号
- `versions()`: 批量获取多个服务的版本号

### MaRegistryController 新增接口

| 方法   | 路径       | 参数                                    | 说明             |
|--------|------------|-----------------------------------------|------------------|
| POST   | `/renew`   | `?service=xxx` + Body: `InstanceMeta`   | 单服务心跳续约   |
| POST   | `/renews`  | `?services=svc1,svc2` + Body: `InstanceMeta` | 批量心跳续约 |
| POST   | `/version` | `?service=xxx`                          | 获取服务版本号   |
| POST   | `/versions`| `?services=svc1,svc2`                   | 批量获取版本号   |

## 测试流程

### 启动服务实例

```bash
# 构建项目
mvn clean package

# 启动服务（端口8081）
java -jar target/maregistry-0.0.1-SNAPSHOT.jar --server.port=8081
```

等待服务启动成功：
```
Tomcat started on port 8081 (http) with context path ''
Started MaregistryApplication in X.XXX seconds
```

### 功能测试步骤

#### 1. 基础注册测试
首先注册一个用户服务实例：

```bash
curl -X POST "http://localhost:8081/reg?service=com.malinghan.UserService" \
  -H "Content-Type: application/json" \
  -d '{
    "scheme": "http",
    "host": "192.168.1.100",
    "port": 8080,
    "context": "userservice",
    "parameters": {
      "env": "dev",
      "version": "1.0.0"
    }
  }'
```

#### 2. 版本号初始状态测试
查询服务初始版本号：

```bash
curl -X POST "http://localhost:8081/version?service=com.malinghan.UserService"
```

预期响应：`0`（初始版本号）

#### 3. 心跳续约测试
执行心跳续约操作：

```bash
curl -X POST "http://localhost:8081/renew?service=com.malinghan.UserService" \
  -H "Content-Type: application/json" \
  -d '{
    "scheme": "http",
    "host": "192.168.1.100",
    "port": 8080,
    "context": "userservice"
  }'
```

再次查询版本号验证：
```bash
curl -X POST "http://localhost:8081/version?service=com.malinghan.UserService"
```

预期响应：`1`（版本号已递增）

#### 4. 批量心跳续约测试
注册订单服务并测试批量续约：

```bash
# 注册订单服务
curl -X POST "http://localhost:8081/reg?service=com.malinghan.OrderService" \
  -H "Content-Type: application/json" \
  -d '{
    "scheme": "http",
    "host": "192.168.1.101",
    "port": 9090,
    "context": "orderservice"
  }'

# 批量续约两个服务
curl -X POST "http://localhost:8081/renews?services=com.malinghan.UserService,com.malinghan.OrderService" \
  -H "Content-Type: application/json" \
  -d '{
    "scheme": "http",
    "host": "192.168.1.100",
    "port": 8080,
    "context": "userservice"
  }'
```

分别查询两个服务的版本号：
```bash
# 查询用户服务版本
curl -X POST "http://localhost:8081/version?service=com.malinghan.UserService"

# 查询订单服务版本
curl -X POST "http://localhost:8081/version?service=com.malinghan.OrderService"
```

预期结果：两个服务版本号都应该为 `2`

#### 5. 批量版本号查询测试
一次性获取多个服务的版本号：

```bash
curl -X POST "http://localhost:8081/versions?services=com.malinghan.UserService,com.malinghan.OrderService"
```

预期响应：
```json
{
  "com.malinghan.UserService": 2,
  "com.malinghan.OrderService": 2
}
```

#### 6. 时间戳验证测试
注册支付服务并观察版本变化：

```bash
# 注册支付服务
curl -X POST "http://localhost:8081/reg?service=com.malinghan.PaymentService" \
  -H "Content-Type: application/json" \
  -d '{
    "scheme": "http",
    "host": "192.168.1.102",
    "port": 7070,
    "context": "paymentservice"
  }'

# 查询支付服务版本号
curl -X POST "http://localhost:8081/version?service=com.malinghan.PaymentService"
```

预期响应：`1`（新服务初始版本号为1）

## 关键设计特点

### 1. 版本号机制
- **服务级别版本号**：每个服务独立维护版本号，注册/注销/续约都会递增
- **全局版本号**：跟踪整个注册中心的变更情况
- **客户端轮询**：客户端缓存版本号，定期对比，版本变化时才拉取新实例列表

### 2. 心跳续约优化
- **单服务续约**：`/renew` 接口用于单个服务的心跳
- **批量续约**：`/renews` 接口支持一次续约多个服务，减少网络请求
- **时间戳格式**：`service@url` 格式便于后续健康检查解析

### 3. 并发安全保障
- 使用 `synchronized` 关键字保证核心操作的线程安全
- `ConcurrentHashMap` 用于无锁读取操作
- `AtomicLong` 确保全局版本号的原子性递增

## 性能考虑

### 时间复杂度
- 注册/注销：O(n)，其中n为该服务已注册的实例数
- 心跳续约：O(1)
- 版本查询：O(1)
- 批量版本查询：O(m)，其中m为查询的服务数量

### 内存使用
- 时间戳存储：每个实例一个条目
- 版本号存储：每个服务一个条目
- 全局版本号：单个原子长整型

## 后续优化方向

1. **持久化存储**：当前使用内存存储，重启后数据丢失
2. **过期清理**：定期清理长时间未续约的实例时间戳
3. **监控告警**：添加版本号变化的监控和告警机制
4. **性能优化**：对于大规模服务场景，可考虑分片存储
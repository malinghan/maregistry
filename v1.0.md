# v1.0 — 基础注册与发现

## 代码结构

```
src/main/java/com/malinghan/marpc/maregistry/
├── MaregistryApplication.java          # Spring Boot 入口
├── MaRegistryController.java           # REST 控制器，暴露 /reg /unreg /findAll
├── model/
│   └── InstanceMeta.java               # 服务实例数据模型
└── service/
    ├── RegistryService.java            # 注册服务接口
    └── MaRegistryService.java          # 内存实现
```

## 核心功能实现

### InstanceMeta

服务实例的数据模型，字段：`scheme / host / port / context / parameters`。

关键设计：`@EqualsAndHashCode(of = {"scheme", "host", "port", "context"})`，用这四个字段判断两个实例是否相同，`parameters` 不参与比较。提供 `toUrl()` 方法生成 `scheme://host:port/context` 格式的 URL。

### RegistryService 接口

```java
InstanceMeta register(String service, InstanceMeta instance);
InstanceMeta unregister(String service, InstanceMeta instance);
List<InstanceMeta> getAllInstances(String service);
```

`service` 参数为服务名（如 `com.malinghan.UserService`），作为注册表的 key。

### MaRegistryService（内存实现）

存储结构：`LinkedMultiValueMap<String, InstanceMeta>`，一个 key 对应多个实例。

- `register`：先检查是否已存在，避免重复注册；加 `synchronized` 保证并发安全。
- `unregister`：从列表中移除目标实例；加 `synchronized`。
- `getAllInstances`：直接返回对应 key 的实例列表，无锁读。

### MaRegistryController

| 方法   | 路径       | 参数                                    | 说明         |
|--------|------------|-----------------------------------------|--------------|
| POST   | `/reg`     | `?service=xxx` + Body: `InstanceMeta`   | 注册实例     |
| POST   | `/unreg`   | `?service=xxx` + Body: `InstanceMeta`   | 注销实例     |
| GET    | `/findAll` | `?service=xxx`                          | 查询所有实例 |

## 测试流程

测试类：`MaRegistryV1Test`（纯单元测试，不启动 Spring 容器）

| 测试方法             | 验证场景                                   | 预期结果         |
|----------------------|--------------------------------------------|------------------|
| `registerAndFindAll` | 注册一个实例后查询                         | 返回 1 个实例    |
| `noDuplicateRegister`| 同一实例注册两次                           | 列表中仍只有 1 个 |
| `unregister`         | 注册两个实例，注销其中一个                 | 剩余 1 个正确实例 |
| `multipleServices`   | 两个不同服务各注册一个实例，分别查询       | 互不干扰，各 1 个 |

运行结果（全部通过）：

```
Tests run: 4, Failures: 0, Errors: 0, Skipped: 0
```

控制台输出：

```
Registered instances: [InstanceMeta(scheme=http, host=localhost, port=8080, context=, parameters={})]
After duplicate register: [InstanceMeta(scheme=http, host=localhost, port=8080, context=, parameters={})]
After unregister inst1: [InstanceMeta(scheme=http, host=localhost, port=8081, context=, parameters={})]
UserService instances: [InstanceMeta(scheme=http, host=host1, port=8080, context=, parameters=)]
OrderService instances: [InstanceMeta(scheme=http, host=host2, port=9090, context=, parameters={})]
```
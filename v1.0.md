# v1.0 — 基础注册与发现

## 代码结构

```
src/main/java/com/malinghan/marpc/maregistry/
├── MaregistryApplication.java          # Spring Boot 入口
├── MaRegistryController.java           # REST 控制器，暴露 /reg /unreg /findAll
├── model/
│   └── InstanceMeta.java               # 服务实例数据模型
└── service/
    ├── RegistryService.java            # 注册服务接口
    └── MaRegistryService.java          # 内存实现
```

## 核心功能实现

### InstanceMeta

服务实例的数据模型，字段：`scheme / host / port / context / parameters`。

关键设计：`@EqualsAndHashCode(of = {"scheme", "host", "port", "context"})`，用这四个字段判断两个实例是否相同，`parameters` 不参与比较。提供 `toUrl()` 方法生成 `scheme://host:port/context` 格式的 URL。

### RegistryService 接口

```java
InstanceMeta register(String service, InstanceMeta instance);
InstanceMeta unregister(String service, InstanceMeta instance);
List<InstanceMeta> getAllInstances(String service);
```

`service` 参数为服务名（如 `com.malinghan.UserService`），作为注册表的 key。

### MaRegistryService（内存实现）

存储结构：`LinkedMultiValueMap<String, InstanceMeta>`，一个 key 对应多个实例。

- `register`：先检查是否已存在，避免重复注册；加 `synchronized` 保证并发安全。
- `unregister`：从列表中移除目标实例；加 `synchronized`。
- `getAllInstances`：直接返回对应 key 的实例列表，无锁读。

### MaRegistryController

| 方法   | 路径       | 参数                                    | 说明         |
|--------|------------|-----------------------------------------|--------------|
| POST   | `/reg`     | `?service=xxx` + Body: `InstanceMeta`   | 注册实例     |
| POST   | `/unreg`   | `?service=xxx` + Body: `InstanceMeta`   | 注销实例     |
| GET    | `/findAll` | `?service=xxx`                          | 查询所有实例 |

## 测试流程

### 启动服务实例

首先启动maregistry服务注册中心：

```bash
# 构建项目
mvn clean package

# 启动服务（默认端口8080）
java -jar target/maregistry-0.0.1-SNAPSHOT.jar

# 或者指定端口启动
java -jar target/maregistry-0.0.1-SNAPSHOT.jar --server.port=8080
```

等待控制台显示服务启动成功的消息：
```
Started MaregistryApplication in X.XXX seconds
Tomcat started on port(s): 8080
```

### 功能测试步骤

#### 1. 注册服务实例测试

注册一个用户服务实例：

```bash
curl -X POST "http://localhost:8080/reg?service=com.malinghan.UserService" \
  -H "Content-Type: application/json" \
  -d '{
    "scheme": "http",
    "host": "192.168.1.100",
    "port": 8080,
    "context": "userservice",
    "parameters": {
      "env": "dev",
      "version": "1.0.0"
    }
  }'
```

预期响应：
```json
{
  "scheme": "http",
  "host": "192.168.1.100",
  "port": 8080,
  "context": "userservice",
  "parameters": {
    "env": "dev",
    "version": "1.0.0"
  }
}
```

#### 2. 查询所有实例测试

查询用户服务的所有注册实例：

```bash
curl "http://localhost:8080/findAll?service=com.malinghan.UserService"
```

预期响应：
```json
[
  {
    "scheme": "http",
    "host": "192.168.1.100",
    "port": 8080,
    "context": "userservice",
    "parameters": {
      "env": "dev",
      "version": "1.0.0"
    }
  }
]
```

#### 3. 重复注册测试

再次注册相同的实例（应该不会重复）：

```bash
curl -X POST "http://localhost:8080/reg?service=com.malinghan.UserService" \
  -H "Content-Type: application/json" \
  -d '{
    "scheme": "http",
    "host": "192.168.1.100",
    "port": 8080,
    "context": "userservice"
  }'
```

再次查询验证：
```bash
curl "http://localhost:8080/findAll?service=com.malinghan.UserService"
```

预期结果：仍然只有1个实例

#### 4. 注销实例测试

注销已注册的实例：

```bash
curl -X POST "http://localhost:8080/unreg?service=com.malinghan.UserService" \
  -H "Content-Type: application/json" \
  -d '{
    "scheme": "http",
    "host": "192.168.1.100",
    "port": 8080,
    "context": "userservice"
  }'
```

查询验证注销结果：
```bash
curl "http://localhost:8080/findAll?service=com.malinghan.UserService"
```

预期响应：空数组 `[]`

#### 5. 多服务测试

注册订单服务实例：

```bash
curl -X POST "http://localhost:8080/reg?service=com.malinghan.OrderService" \
  -H "Content-Type: application/json" \
  -d '{
    "scheme": "http",
    "host": "192.168.1.101",
    "port": 9090,
    "context": "orderservice"
  }'
```

分别查询两个服务：

```bash
# 查询用户服务
curl "http://localhost:8080/findAll?service=com.malinghan.UserService"

# 查询订单服务
curl "http://localhost:8080/findAll?service=com.malinghan.OrderService"
```

预期结果：
- UserService：空数组（已被注销）
- OrderService：包含1个实例

### 测试验证要点

1. **服务启动验证**：确认服务正常启动并在指定端口监听
2. **注册功能**：能够成功注册服务实例
3. **查询功能**：能够正确返回已注册的实例列表
4. **去重机制**：相同实例不会被重复注册
5. **注销功能**：能够正确移除已注册的实例
6. **多服务隔离**：不同服务之间的实例互不干扰
7. **数据持久性**：在同一次服务运行期间，数据能够正确维护